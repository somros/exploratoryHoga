{
    "collab_server" : "",
    "contents" : "# 27.10.2016 script for  CAP analysis. Ordination of sites depending on their composition, as decided by the abundance of each species,\n# correlated with environmental variables (namely time and space in this case). Environmental varibales are ANOVA-like factors and\n# not continuous dimensions. \n\n\nrequire(abind)\nrequire(MASS)\nrequire(ggplot2)\nrequire(BiodiversityR)\nrequire(ggvegan)\n\n\nsetwd(\"//Staff/Home/SCIFAC/rovellal/DocumentsRedir/Data/Hoga/buoy3\")\nmyData <- read.csv(\"spongeAbundanceQuadrats.csv\")\n\n# turn to numeric immediately\n\nmyData <- myData[c(1:124),]\nmyData <- apply(myData, 2, as.numeric)\nmyData[is.na(myData)] <- 0 # turns NAs in 0, as necessary for Bray-Curtis\n\n\n# some steps to break down the frame in a list of frames, one per year per site.\n\nnOfQuadrats <- 5\n\n\n\n# TODO: introduce routine to cut data frames to the species accounting for 90% of the abundance. must be applied\n# to each quadrat and then all the species considered make the subset key for the entire data frame\n\n# we do it with apply. jk lol use a loop apply is slow af anyway\n\nperc <- 90\n\nspecies <- vector(\"list\", length = ncol(myData)-1)\n\nfor (k in 2:ncol(myData)) {\n  dataOrd <- myData[order(myData[,k], decreasing = T),]\n  # does the math: sum all the entries in one column to get the total\n  totNum <- sum(dataOrd[,k])\n  n <- totNum*perc/100\n  ntmp <- 0\n  spy <- 0\n  for (i in 1:nrow(dataOrd)) {\n    if (ntmp < n) {\n      ntmp <- ntmp + dataOrd[i,k]\n      spy <- i\n    } else {\n      ntmp <- ntmp\n      spy <- spy\n    }\n  }\n  species[[k]] <- dataOrd[c(1:spy),1]\n}\n\nspecies <- factor(levels(factor(unlist(species))))\n\n# now subset original data\n\nsubsetData <- myData[myData[,1] %in% species,] # there we go\n\n\n# if for whatever reason we want to use the entire set of species for the analysis, we can get rid of the above\n# section (this should become a flag). \n# the above routine may be better off if used on the means. That would rule out all the outliers from the\n# single quadrats. The number of species is however half the original amount.\n\n\ndataQuad <- subsetData[,-1] # remove species for convenience\n\n\n# create vector of indeces for consequent loop (breakage)\n\nindeces <- rep(1:30, each = 5)\n\ndataQuadN <- rbind(indeces, dataQuad)\n\n# split into list depending on the index\n\nnewList <- vector(mode = \"list\", length = length(indeces)/nOfQuadrats)\n\nfor (i in 1:length(newList)) {\n  subsetFrame <- dataQuadN[1,]==i\n  newList[[i]] <- dataQuadN[,subsetFrame]\n}\n\n\n\n\n# get rid of the index and make row means (sd later)\n\nnewListMeans <- lapply(newList, function(x) {\n  y <- x[-1,]\n  z <- rowMeans(y)\n  frame <- as.data.frame(z[1:nrow(dataQuad)])\n  colnames(frame) <- paste(\"Mean\", substr(names(x[1,])[1], 2,3), substr(names(x[1,])[1], 5, 5), sep = \"\")\n  return(frame)\n})\n\n\nallMeans <- as.data.frame(abind(newListMeans, along = 2))\n\n# transform in log(x+1). we can debate wether we want to have this done here or earlier. as a rule of thumb,\n# the earlier the better. Need to investigate the sensitivity to this of the MDS plot though, prepare 2 versions\n\n\nallMeansTrans <- log10(allMeans+1)\n\n\n# first we transpose (which is not necessary now but should become at some point I reckon)\n\ntransMatrix <- t(allMeansTrans)\n\n# now structure is N as rows and species as columns. However, we osu old structure for computation (same ending point and I don't\n# have to recode it all up)\n\ngrandBC <- list()\n\nfor (i in 1:length(allMeansTrans)) {\n  BC <- vector(mode = \"logical\", length = length(allMeansTrans))\n  for (j in 1:length(allMeansTrans)) {\n    reduced <- allMeansTrans[,c(i,j)]\n    BCpartial <- apply(reduced, 1, function(x) {\n      numBC <- 2*min(x[1], x[2])\n      denBC <- x[1]+x[2]\n      metrics <- c(numBC, denBC)\n    })\n    BC[j] <- rowSums(BCpartial)[1]/rowSums(BCpartial)[2]\n  }\n  grandBC[[i]] <- BC\n} # minchia che culo\n\nkekes <- abind(grandBC, along = 0)\ncolnames(kekes) <- names(allMeansTrans)\nrownames(kekes) <- names(kekes)\n\n\n# now metric MDS plots, or PCO\n\n# turn intodissimilarity\n\ndissMatrix <- 1-kekes\n\nfit <- isoMDS(dissMatrix, k = 2) # this is a ***NON-METRIC*** MDS plot based on Brey-Curtis dissimilarity.\n\ndistances <- as.data.frame(fit$points)\nrownames(distances) <- names(allMeansTrans)\ndistances$Names <- as.character(rownames(distances))\nfor (i in 1:nrow(distances)) {\n  distances$Year[i] <- paste(\"20\", substr(distances$Names[i], \n                                          (nchar(distances$Names[i])-2), \n                                          (nchar(distances$Names[i])-1)),\n                             sep = \"\")\n}\nfor (i in 1:nrow(distances)) {\n  distances$Site[i] <- substr(distances$Names[i], nchar(distances$Names[i]), nchar(distances$Names[i]))\n}\n\n# plot\n\nMDSplot <- ggplot(data = distances, aes(x = V1, y = V2, group = Site, color = Year))+\n  geom_hline(yintercept = 0, linetype = \"dashed\")+\n  geom_vline(xintercept = 0, linetype = \"dashed\")+\n  geom_text(aes(label = Year, color = Year), size = 4.5, \n            fontface = \"bold\", vjust = 0, nudge_y = 0.02)+\n  guides(color=FALSE)+\n  geom_point(aes(shape = Site, color = Year), size = 2)+\n  scale_shape_manual(values = c(0,1,2))+\n  labs(x = \"MDS1\", y = \"MDS2\")+\n  #geom_path(size = 1)+\n  scale_x_continuous(limits = c(-.7,.7))+\n  scale_y_continuous(limits = c(-.7,.7))+\n  theme_bw()+\n  theme(\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.major.y = element_blank(),\n    panel.grid.minor.y = element_blank())#+\n  #facet_grid(.~Site)\nMDSplot\n\nggsave(\"//Staff/Home/SCIFAC/rovellal/DocumentsRedir/Wellington/words/latex/hogaExploratory/Pics/MDSplot.pdf\",\n               MDSplot, useDingbats = T, width = 6, height = 5)\n\n# calculating the dissimilarity matrix among all instances (site*year) we see an influence of space in clustering.\n# temporal variation and return to original conditions is a bit less evident but still well visible considering the \n# sites one at a time. good plot, now need to go on and end up with the CAP for the species!!!\n\n\n# CAP uses a dedicated package and starts from the species list\n\n# need to build a dummy frame apparently with data\n\ndummyMatrix <- as.data.frame(cbind(distances$Year, distances$Site))\ncolnames(dummyMatrix) <- c(\"Year\", \"Site\")\nrownames(dummyMatrix) <- rownames(transMatrix)\n\n# different formulas mean different ordinations, depending on the included variables\n\nCAPall <- capscale(transMatrix ~ Year + Site, dummyMatrix, distance = \"bray\", add = T)\nCAPTime <- capscale(transMatrix ~ Year, dummyMatrix, distance = \"bray\", add = T)\nCAPSpace <- capscale(transMatrix ~ Site, dummyMatrix, distance = \"bray\", add = T)\n\n# plots for different formulas\n\nplot(CAPall)\nplot(CAPTime)\nplot(CAPSpace)\n\n# all the below is just to get fancy with ggplot. Packages vegan and ggvegan will do all the job\n\ncomponents <- fortify(CAPall) # extract the coordinates from the cca objects calculated with capscale \ncomponents <- data.frame(lapply(components, function(x) {\n  x <- gsub(\"Year\", \"\", x)\n  x <- gsub(\"Site\", \"\", x)\n  x <- gsub(\"Mean\", \"\", x)\n  return(x)\n}))\ncomponents$Dim1 <- as.numeric(as.character(components$Dim1))\ncomponents$Dim2 <- as.numeric(as.character(components$Dim2))\ncomponents$Label <- gsub(\"spe\", \"\", components$Label)\n\n\n# plotting region\n\nplotData <- subset(components, components$Score != \"biplot\" & components$Score != \"constraints\" &\n                    components$Score != \"sites\")\nplotData$ColorKey <- c(rep(\"species\", 75), rep(\"year\", 10), rep(\"site\", 3)) # make this flexible on the iterations\n# fix levels\nplotData$ColorKey <- factor(plotData$ColorKey, levels = unique(plotData$ColorKey))\n\n\nCAPplot <- ggplot(data = plotData, aes(x = Dim1, y = Dim2, group = ColorKey))+\n  geom_hline(yintercept = 0, linetype = \"dashed\")+\n  geom_vline(xintercept = 0, linetype = \"dashed\")+\n  geom_segment(data = subset(plotData, plotData$Score == \"centroids\"),\n               aes(x = 0, xend = Dim1, y = 0, yend = Dim2), arrow = arrow(length = unit(1/2, 'picas')))+\n  geom_text(aes(label = Label, color = ColorKey, size = ColorKey))+\n  scale_color_manual(values = c(\"darkgrey\", \"red3\", \"cyan4\"))+\n  scale_size_discrete(range = c(4,8))+\n  theme_bw()+\n  labs(x = \"CAP1\", y = \"CAP2\")+\n  scale_x_continuous(limits = c(-.8,.8))+\n  scale_y_continuous(limits = c(-.8,.8))+\n  theme(\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.major.y = element_blank(),\n    panel.grid.minor.y = element_blank())\nCAPplot\n\nggsave(\"//Staff/Home/SCIFAC/rovellal/DocumentsRedir/Wellington/words/latex/hogaExploratory/Pics/CAPplot.pdf\",\n       CAPplot, useDingbats = T, width = 6.5, height = 5)\n",
    "created" : 1477431791630.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1813324262",
    "id" : "1A0A0662",
    "lastKnownWriteTime" : 1477523017,
    "last_content_update" : 1477523017324,
    "path" : "//staff/Home/SCIFAC/rovellal/DocumentsRedir/rProjects/hoga/exploratoryHoga/trunk/CAP.R",
    "project_path" : "CAP.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}